package com.tmall.wireless.tac.biz.processor.youbaozang;

import com.alibaba.cola.extension.Extension;
import com.alibaba.common.lang.StringUtil;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.google.common.base.Joiner;
import com.google.common.base.Splitter;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.tmall.txcs.biz.supermarket.iteminfo.source.captain.ItemInfoBySourceDTOMain;
import com.tmall.txcs.biz.supermarket.iteminfo.source.origindate.ItemInfoBySourceDTOOrigin;
import com.tmall.txcs.gs.framework.extensions.buildvo.BuildItemVOExtPt;
import com.tmall.txcs.gs.framework.extensions.buildvo.BuildItemVoRequest;
import com.tmall.txcs.gs.framework.model.ErrorCode;
import com.tmall.txcs.gs.framework.model.ItemEntityVO;
import com.tmall.txcs.gs.model.Response;
import com.tmall.txcs.gs.model.model.dto.ItemEntity;
import com.tmall.txcs.gs.model.spi.model.ItemDataDTO;
import com.tmall.txcs.gs.model.spi.model.ItemInfoBySourceDTO;
import com.tmall.txcs.gs.model.spi.model.ItemInfoDTO;
import com.tmall.wireless.tac.biz.processor.common.ScenarioConstantApp;
import org.apache.commons.collections.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.poi.ss.formula.functions.Na;
import org.springframework.stereotype.Service;

import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * Created by yangqing.byq on 2021/5/11.
 */
@Extension(bizId = ScenarioConstantApp.BIZ_TYPE_SUPERMARKET,
        useCase = ScenarioConstantApp.LOC_TYPE_B2C,
        scenario = ScenarioConstantApp.SCENARIO_YOU_BAO_ZANG)
@Service
public class YouBaoZangBuildItemVOExtPtImpl implements BuildItemVOExtPt {


    public static final String NATIONAL_CODE = "格鲁吉亚;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01oMFWPo1es9dM5d4AP_!!4118363926.png;410877983" +
            "\n沙特阿拉伯;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01hOwNgS1es9dPw4x1l_!!4118363926.png;258372107" +
            "\n日本;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01976UNL1es9dGuE4vo_!!4118363926.png;296870935,3514579,3853789,4347044,597122431,38819,94584,20096,3309062,100295,3332968,61048174,7637686,6301204,20448,4495871,66588,270072236,3503462,7634663,3381010,3744935,94388,187664379,4275257,4200388,961272547,559408809,9191554,707648568,3453364,1380497336,1075050902,76146176,634358706,1479745605,101649175,20025,818104162,110079,3473146858,22694279,44802248,32638,152727047,16132573,20439,1473904936,1877120523,93097,16189855,577784824,66930,372718624,1128254335,42343923,146801470,125844877,323302271,6848766,12730929,304248221,287422556,105062,20029,20402,100135780,16707128,94831129,3322857,1523006974,1284566721,1163632260,9381299,3329843,4108629,12024178,3288209,3315812,3694919,623528101,203654754,3600519,107395,3335316,1646457932,9045511,21763808,236046420,48023771,1076032260,42074504,3726885,600821760,201474861,2581824827,4117416387,1949963745,3319375,217958513,3214507,6994450,7037893,5119357736,42931484,4709920708,6408708,59744,1178158235,3692296,1946534703,5268985869,5126755789,6907687942,890898308,94843581,634106435,20138,3302415,8604159,7076820,11889310,84320770,15368566,9764699,6071546,1880915241,302368548,1952859654,90824254,246954036,540052302,7694279,2887631613,53229303,95277133,968282236,7293911,293606007,46375402,1530197993,3772643364,5214756398,7665128,3316176,66935,3322567,2364666459,768394484,9528307,7307109599,3456565,44274877,27101382,8611395,1055434663,530416891,7077206862,9248224,4361701,20067,18641319,41342,7066493,9036213596,707822318,34005155,8972225095,3326501,8644759533,5657008877,704832453,52011932,6215769886,8122537293,13039303441,63596588,11176312,20099,709208407,3873727,11446908,2369769473,13026115986,30061,336808998,775078191,67964109,2489833450,1959405536,9216034688,4533922,67170038,179438797,739966848,87362809,32937485,3937203,8481615,125992,9714792,7076114142,1929533533,12058680986,4400084,3887275,678820071,20316,39324583,8193023624,66924,60258297,152368768,1877172583,4062495,33523306,119538,2326731661,20085,3665960,58634785,19544130,2879366449,206279000,51148015,2480878278,1863350973,765148312,495619332,46750721,138947456,11419637,3365380,12124279,1761405205,1863326589,75515389,1863363856,1149334669,1958323656,9138475,119066,207478485,4131116,1973850241,20060,544454905,70780258,20330,236540392,145521934,1655463947,3217426,9802348,27700506,152368768,4374735010,4171056,8720890,7431359669,45618,836030185,12720325,4258898,47202962,6931416,850744084,147438238,1954602317,20022,154777735,1415784840,6443282,112990774,149515303," +
            "\n玻利维亚;https://img.alicdn.com/imgextra/i3/4118363926/O1CN018XepJC1es9dGu8mL3_!!4118363926.png;678252611,6637017904," +
            "\n巴西;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01Qr1Tml1es9dJSYCsl_!!4118363926.png;287612944,1128254335,7985097033,606506610,53650,5472445003," +
            "\n阿根廷;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01CzDqBu1es9dAhi7Q4_!!4118363926.png;39887589,7993432418,2206509725,3308819,11021721,6560228155," +
            "\n哥伦比亚;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01eEKCf61es9dKvWBRj_!!4118363926.png;287612944,5170364139,148500087," +
            "\n智利;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01W0hgyQ1es9dNPTDxD_!!4118363926.png;662368586,11251751,7370865,98076104,39887589,7023793116,1312426135,14797806,598980929,176836282,3085434446,1311966024,29504223,7431078006,29534,1035098645,4539140,1506138316,230722431,226150402,3308819,18543452,4062495,53150466,67948033," +
            "\n秘鲁;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01CPDIwj1es9dHRRIYY_!!4118363926.png;29534,4062495," +
            "\n厄瓜多尔;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01YLpjHU1es9dOQwF9v_!!4118363926.png;2713007487,2240616284,95939274,230722431," +
            "\n波多黎各(美);https://img.alicdn.com/imgextra/i4/4118363926/O1CN01GAabMB1es9dM5amoL_!!4118363926.png;4535635" +
            "\n墨西哥;https://img.alicdn.com/imgextra/i4/4118363926/O1CN016axbwC1es9dFViRW0_!!4118363926.png;950844533,15332451,4533284,151345407,119569,4535635,29534,4062495,3303543,30814,3516041," +
            "\n美国;https://img.alicdn.com/imgextra/i3/4118363926/O1CN019GryVQ1es9dQYsmNl_!!4118363926.png;121865378,38713269,277660381,94519,534372548,67396369,287048435,222224951,10438261,4539760,44652,128185668,20033,187430567,102864,60736176,81755415,1736103701,137515586,1451627835,42832461,3485944,3993829,3656361,1193794452,50641283,320066129,357062015,9329232,707822318,139196808,272554766,6322193069,4448937,3310164,20080,7076820,70772758,1123338902,27961,10636538,781782164,15244504,32961794,55655,64203397,15849708,785884540,1907242866,20022,2582300215,364904882,121447541,378704827,119569,129337011,235818241,65167205,55656,55664,633534696,1384076816,14130316,29534,171368919,3304475,20005,7162669087,158238010,82492215,7431078006,61132529,1863349425,1093880284,44651,4535615,9553711,7370865,950844533,3278173,94390,66924,4062495,6967333,690710285,4738676156,370144273,3683806,3500789923,1880225394,5711793,4536184,20316,3266761,6965217,1405002546,1890803555,119567,107655401,26913639," +
            "\n加拿大;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01A4FBRd1es9dMvGqU7_!!4118363926.png;94390,59733,94390,1947849128,1944400165,9369494,1862115078,1880230078,120077978,1165675247,3993829,1944098116,15849708,5662554847,2713007487,4290625,8909252,7487407,3358056,3271526,3318255,159199733,66924,230722431," +
            "\n捷克;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01kBwY2q1es9dHRRdKx_!!4118363926.png;238632074,9191554,279476852,5049513," +
            "\n挪威;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01hXOGQg1es9dPw65ia_!!4118363926.png;176836282,49196351," +
            "\n摩尔多瓦;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01GETMow1es9dGuAzeS_!!4118363926.png;410877983" +
            "\n德国;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01xdfodq1es9dGuAaf4_!!4118363926.png;20451,18756822,47413,3579906,212408420,148547497,138013196,27879732,967844097,9314662,216616331,225528163,101286946,687162379,3425417,242738965,37428526,39482539,20316,1075050902,110071,31296621,20081,85691,66554,18916761,208874640,287612944,1298240245,561686699,94519,44349737,20579,1385976826,1802808528,9005705,579432509,543102218,116560491,8696390,1883228790,1769636880,4535981,341276432,630380582,12097331,12987125,1863346496,988842302,1880914269,221964309,283888428,606754911,54729546,201890903,1326105561,975109876,1533900951,120078,1880225394,3326302,418808412,3222887,617164001,680624225,1298228375,20661910,215536073,599686303,1959405536,1753690240,2879990096,605942710,203712495,1951904110,123412612,5661278087,562794434,5377498410,9928674015,9130532,658222001,7176338505,1977898707,52696308,9036226900,60356481,647802701,2902347461,134090762,94669233,273926269,691920188,8059484158,7431078006,3441120,3516041,101219656,695036818,37537568,926692266,625476805,6378099,1863389558,102864,66924,240182643,272702285,316580687,11043650,89468232,16636334,773640578,67348031,728036647,150059274,126336538,6411362,20025,1464115395,55298689,89142593,2763266795,1386264846,2228327055,20872197,366454553,28913,186246041,6079150,2578930020,325540164,1953129033,5173701268,3273764," +
            "\n英国;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01Xxuag91es9dFVj7A9_!!4118363926.png;4533614,4533616,66911,44443517,638508672,4536184,258372107,94583,15047918,281094200,204074749,5919912,493658060,1955899435,159593596,20316,269616529,70908137,171368919,184576363,5930374,6071546,23167400,14995758,154096170,17689155,143016634,4142891,3564346,5415537289,20080,210606426,921290529,2443531877,1940273870,7076820,113262522,1863349425,152927464,378514006,738464293,16508576,6591753569,269642469,743010121,3715227,633534696,4539760,4535635,9987379,937904892,3323174,363342072,4536537216,182562928,6325603,67801,248462551,2263837764,10472595,1896435992,132555039,3949661,17965247,115863089,6272725232,362370203," +
            "\n瑞士;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01QxIDwg1es9dNPSYKi_!!4118363926.png;52914076,20316,3620450,6844290,3471431,20313,6071546,2641832118,3597021,5625381104,4171353299,1844707749,110071,4062495,10889100,66924,6560228155," +
            "\n奥地利;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01xyaZg01es9dP07Voj_!!4118363926.png;8228443,1880914269,237850906,1505569102,1933917697,640550412,8420015,1863346496,114206106,1533900951,2726191608,3315486,110462,4062495,28168281,675578770,47676,989558137," +
            "\n意大利;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01FaQxhL1es9dPw5kze_!!4118363926.png;110910,116560491,66554,255754159,3597021,9967783,104391965,862054125,3292179,135319683,3585150,28169448,110071,364278259,707140656,1093786142,51462495,1863350851,104887478,122683575,364188376,827122513,57556786,13527963,638508672,88534507,3220417,33926713,586816290,7248515942,15007036,669874065,94831129,115872453,1732527825,1396837857,6696283686,13405564,49674432,654464866,282094591,14524936,626364866,20110,707148314,15849708,1891651063,44924,60418984,5757610304,2354195005,9191554,11043650,611666090,965570284,124474431,1125660479,65363418,7431078006,52696308,158638260,3228163,6411362,46437724,929220041,206602256,367516772,2281144199,4535635,2392544051,28604479,20361280,282154958,1096220326,4005853,754092105,985778105,111333541,147696666,2252879487,110913,69385267,493524402,139252007,904980574,4535620,25287816,1076166727,111450037,8731398,31042789,128424296,4062495,365140388,867644840,3266761,132681745,66924," +
            "\n芬兰;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01pMobev1es9dOQupsN_!!4118363926.png;4805444322,8111466," +
            "\n比利时;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01LBFyUF1es9dQYph4H_!!4118363926.png;110072,137515586,199152254,89466671,47531046,78956277,11330189,189884438,3334836,151454811,27879732,795158621,50641283,25590188,22247811,1965602363,129178749,1571751300,60735517,29205596,201890903,119567,108263886,142177761,3983634,134437989,137888,10733063,110462,5171404203,4062495,959312248," +
            "\n爱尔兰;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01g5HbWi1es9dP09Bl7_!!4118363926.png;20324,7326664,736634244,20317,20313,91959695,3884437,283026084,31939,55656,269642469,60418984,43578,4062495," +
            "\n希腊;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01xyJ08Z1es9dM5cWzo_!!4118363926.png;135319683,6125774,1007992604,1078530062,679454001,867644840,49308745,882792229," +
            "\n保加利亚;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01V0TfhR1es9dKvY3r1_!!4118363926.png;13789185" +
            "\n匈牙利;https://img.alicdn.com/imgextra/i4/4118363926/O1CN010828hG1es9dJwkav5_!!4118363926.png;1848940749,7431078006,630380582," +
            "\n波兰;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01H8iMte1es9dOQuprJ_!!4118363926.png;4537009,12987125,89466671,554492980,138013196,1863346496,2726088661,247364813,5268985869,66554,4533285,317466212,89468232,27961," +
            "\n法国;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01QOBydp1es9dM5a34g_!!4118363926.png;20038,20003,110072,20109,316440803,59734,4535618,4142891,113670556,110071,3269368,700274115,117537096,5310237294,611468464,51110477,30372,6549370,39887589,92572951,153057356,15791542,20069,289198504,3500955,16789803,1622014089,288808174,3486446,137848803,20326,1771505133,20403,2235613678,659446217,9323708,641411000,8633803,20316,7697089,1907109840,789152258,8587341,3564346,33477,94583,1970281648,1953799144,2294285760,1001026294,120078,1097114207,20070,669874065,4378390135,2458143439,85691,182588018,54680017,52956882,3085434446,20107,4536184,20067,205920322,20008,20051,20097,7909618,248506490,804464198,498766944,15280890,130803873,3310524,82868128,30134,3889310,20031,364904882,6071546,4394856,2582300215,37917849,30061,20020,101345461,20022,537072361,3624510466,4573529177,2879937184,7593169,662072726,1966395296,9565734,94584,4535635,7431078006,4182846,9195822151,220502965,66924,269642469,280258089,30856,1947933202,36394705,226150402,3573277,140302740,239806378,3586485,10741464,135431558,269598819,270480512,1880225394,74626407,4062495,125992,80326091,67481932,3939832,20110,278366108,8259275,26894440,361070807,3289492,1802818078,296418014,130456120,3263526,2800905244,590022244,18526734,245872027,11520742,1947065002,6324834138,17549599,1135926227,3864639,89002009,234172058,16837010,11612306181,333856971,730696882,9022982,116242334," +
            "\n俄罗斯;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01Fk50mm1es9dKvVqgZ_!!4118363926.png;617960958,20316,1876129017,203286994,2713007487,1313776937,1606371412,5268985869,264396371,10306821214,228392299,6049487,4062495,808466300," +
            "\n荷兰;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01Dy0EuY1es9dNPPOpZ_!!4118363926.png;216616331,649520265,20314,20316,638508672,995656201,199152254,3731790,101286946,70908137,9478372,127922167,526234518,535726456,129178749,616168640,4733217997,3316522,50059130,146067303,20324,617296851,20111,1958387513,12521753498,20323,141677822,201404522,11021721,1684952973," +
            "\n斯洛文尼亚;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01YRYyLS1es9dJwnD62_!!4118363926.png;7431078006" +
            "\n瑞典;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01tKm1V21es9dFVgISE_!!4118363926.png;16743421,271612289,3983634," +
            "\n葡萄牙;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01y6IPPu1es9dKvWikl_!!4118363926.png;109385108,6071546,17361556,3560040,8348016705,71192806," +
            "\n拉脱维亚;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01VoQx4I1es9dGuDXe9_!!4118363926.png;247364813" +
            "\n丹麦;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01y6N2qU1es9dHRQtbB_!!4118363926.png;7469769,20317,148547497,20403,242738965,20661910,3597021,8743801924,132086058,98907984,601920502,5396667968,94303427,4062495,921996524," +
            "\n西班牙;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01GXCESF1es9dOQyWbZ_!!4118363926.png;20317,51462495,3830651,110915,8124813,3292179,1803831833,3352112,13233308,98076104,4539140,882798090,198758134,86187970,611468464,1341195177,12715520397,638508672,92572951,3804972,1891651063,206434544,20081,29650783,159270161,263446737,2392544051,104391965,10220780843,546340050,2495807001,1716512189,221964309,669874065,630380582,1632233216,204010941,7168510952,3475727,6202564855,3293520,708282899,7906000,4533618,20064,2308145024,20033,3089487403,20022,959342404,3012423180,8044521760,8634623334,9331197,10738414,381678732,44274877,36236622,12097172331,7431078006,4062495,645784363,1850646812,71192806,553603763,3694456,3863350,3320257,132086058,17361556,95331195,3379522227,851540090,4878402544,83142106,20579,66924,1562244493,70944269,4940538159," +
            "\n乌克兰;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01fDDCRQ1es9dKfBSGd_!!4118363926.png;5049513,215844395,1767949945,8663689467,3012423180,32133056,1386560073," +
            "\n爱沙尼亚;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01Ju43FZ1es9dOKkqDh_!!4118363926.png;1330275265" +
            "\n新西兰;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01jbK8Vb1es9dOQw6xG_!!4118363926.png;20321,6965217,9660656,195240015,725136661,77740914,20328,153599590,3229540,4386760,187320630,588039908,362066899,233948088,1893473803,4261731,3667458,85691,42556,176836282,1875524176,720622511,50846732,4459048230,6125774,6271579,137887,1337155026,2689148476,606506610,5683480,101758044,614524073,753056079,7431078006,1907242866,29534,1543201609,3269373,10632861709,1980429911,107630206,185292524,53650,145739193,132761760,9312409,6892458,1338468152,559376796,898636520,4062495,14206546,6560228155," +
            "\n澳大利亚;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01hUb91D1es9dJQs5UD_!!4118363926.png;135385360,231468957,277462309,4533628,8997105,9130532,85691,996034170,776792664,11080728,1585887509,19845178,1585923128,1971698061,199152254,4540695,110777770,94391,764362470,134134900,379972300,187320630,54960102,8600966,19397272,725136661,671522295,220690742,110482987,1074286270,2361966958,905038945,201118392,20403,2660422101,45457,139236769,137887,660772076,1857536669,181556545,1237770478,1533900951,646858306,7847359137,3738153,6133335,758008572,7307109599,9057357820,110217,3756597,2206509725,7985097033,1955806175,109079699,2858052130,7771853047,20559,687004689,8246060,4386760,7593169,9462451040,2774386338,132761760,710956511,9312409,136540594,9611160,29534,43100388,1506138316,7373414989,50645788,379058624,8801183,28935806,9947804,4062495,6560228155,110910,6364496,195244021,10999721569,17629385,612348826,1354220836,1903440429,2203183233,599962122,300088462,2274099050,2800905244,945592713,3821410,540704034,132328517,7671424,137045450," +
            "\n古巴;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01LN87Uq1es9dKvXK8Y_!!4118363926.png;4533621,14995758," +
            "\n东帝汶;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01UquWTj1es9dM5cC8k_!!4118363926.png;44652,268474504," +
            "\n柬埔寨;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01JXiDCI1es9dLzWdFo_!!4118363926.png;673286449,6202564855,1124358783,131825568,9578590865," +
            "\n南非;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01juNSl21es9dLzYmJG_!!4118363926.png;78329739,4062495,26689626," +
            "\n孟加拉国;https://img.alicdn.com/imgextra/i1/4118363926/O1CN018RzZk01es9dFPd0zz_!!4118363926.png;1507075230" +
            "\n泰国;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01L644c91es9dMp6qoE_!!4118363926.png;58961263,7393939,208792066,195956155,4536321,3284238,241470279,243462758,3229833,17626103,3256619,131825568,528772357,652716079,45618,94517,289032041,1386544278,634358706,75953289,579224514,281942387,100528499,230294039,7815916,1738165094,6705825,27066,198756072,1124358783,20090,1863514077,7198066,20081,1954574979,1767949945,1899556932,2597291852,1945551527,3485944,89316192,8415533,2496256828,151717510,16779612,13263911,445957253,1945577568,137885,111095635,1771534078,3851438332,71525148,1950999927,39258781,108194047,1507075230,3021519044,2267081187,5442667558,798102731,139236769,233816308,4253052,673286449,47676,1965803013,75915790,85226138,6202564855,140437297,2722289489,125844877,8290235,640094929,1688932806,3403922505,8966518785,109079699,598472681,685602187,1944098116,29468144,12710905,656986608,1001512571,1907242866,9203280690,11114176359,545878228,117389131,9354503506,6036073,228448437,7307109599,1884191641,6601658778,2621958542,7369515,1417147460,20111,377422711,2428606719,12414803165,29534,586842057,3536406,744010380,4062495,155320061,216544779,927582611,50350365,289030160,849920506,187712781,6090236,310294955,921996524,1113628762,627738385,229050466,7014697,635484902,66924,6197541,127363155,110910,13158231,109173,4307648,271078117,10583051,1703620290,1884194634,119066,1675991545,3320114,32638,929220041,1453550551,233770684,986088369,1220058726,8927351,1386553159,20088,2802216957,7529950,8334200227,3832255,41378332,360736662,904980574,245680485,15854428,296134161," +
            "\n韩国;https://img.alicdn.com/imgextra/i2/4118363926/O1CN010kF3x31es9dOKo3vW_!!4118363926.png;114151517,8244311,12983574,132186604,119542,3681631,56984233,147798992,20316,1863514077,66557,6970861,146455388,193900792,15854428,12906190,47191,3316942,75375503,1036034639,38819,10428,119543,1740165188,211850229,110207455,674848095,4382504,233196988,1784543383,4326293,3229936,233324331,608808667,151395098,1442696590,1451627835,791820492,20080,1691690111,1535374843,38358047,1877143025,7655090,1445518705,27134,82913218,4517669,2548933231,3612918,3481454246,2874382454,2879920387,3474031734,5957931191,199152254,4508141938,868402129,27806573,247212153,736286456,8600966,20066,1031958336,1666803597,5156567978,580436157,307194877,102485332,7165446312,2464672675,3459747,5477424337,2298030193,1071706325,6605358,2989166095,1952859654,540052302,595098161,2879937184,18274550,125844877,2459544056,37003805,3637963,67686698,7906370,201222465,8240382467,1759106375,1347966232,3692885,5619610280,3100340574,6458087414,8262430250,279120908,1103424755,559358709,55656,8581057463,603320610,210014237,4144926675,1863326602,2752085932,588974604,6274184125,7342536,10316041,3963429,7307109599,1490418330,1000600174,1749012145,7553587985,62918951,705520229,1139136506,890970397,3311114,4709917621,2637882480,55664,3222890,1379707029,1424459053,94522,8440302,4062495,66924,7222256161,8715620,3273590,817520177,561616916,8237350,153578476,130887549,2482799668,20438,4503419,103022744,7293911,1875514166,110462,554368194,7724367,170226665,56351906,2233870810,29544272,58634785,27417827,3291269,182562783,30812,3416818,3794669,13008244,7868642309,272098027,1112736214,137013301,150133925,1454283561,14206756,1028104014,3366225,984282879,261942585,140326947,4207334,105679,360706640,51646706,789452321,1553959228,158598215,6301204,155728565,7684484,3505637,6125774,1946199828,28067320,201890903," +
            "\n土耳其;https://img.alicdn.com/imgextra/i2/4118363926/O1CN01a22W531es9dJMOYDW_!!4118363926.png;258372107,50641283,640550412,6071546,343016329,313020370,4111165597,1946874527,141915714,1326736070," +
            "\n以色列;https://img.alicdn.com/imgextra/i4/4118363926/O1CN01DB8Zta1es9dKscjUQ_!!4118363926.png;151454811" +
            "\n斯里兰卡;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01FGRIEI1es9dQSlXVk_!!4118363926.png;12617575,597176126,2868112422,1461241259,69026366," +
            "\n马来西亚;https://img.alicdn.com/imgextra/i1/4118363926/O1CN01H8m1Vy1es9dAhk4A5_!!4118363926.png;103299280,4537180,120421039,7410842,16107654,652498457,64935388,6779853,16779612,15939978,272098027,73483903,153806842,157786198,6970861,621348070,44652,967940711,1044702520,597176126,151217977,216618235,641634337,20451,269536615,289032041,50498303,45496,1854879237,30792607,1243622074,1088560341,230294039,3863350,110074,2875027882,206902985,7697089,947868786,15538974,559410666,93848014,671738600,268474504,174648574,2252879487,3917822,110462,2879937184,1688932806,26499001,4510972755,5585997420,80437122,2835188348,234612126,7896134353,7369515,3316522,1163632260,5415920,287422556,113511351,7398536,180546669,730368835,248466241,78956277,117451178,3283425,119080,119567,139041082,8180828,15854428,35388505,4062495,895770610,44545827,11929338,264508357,119062,6852943,597176126,127363155,1671370734,751420189,647502501,309800579,618756395,72250754,1507075230,602628193,27120609,3241008,186800260," +
            "\n菲律宾;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01Hu2EvN1es9dMp5J5K_!!4118363926.png;663946035,599944327,967940711,818760062,954842285,20316,2428606719,211762978,4062495,11475437,7529950,1786742194," +
            "\n越南;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01Cxy3yf1es9dFSqfYz_!!4118363926.png;7259025,6735462,187650229,3294251,1863514360,4536557,97545005,289032041,101336503,1169410607,99964150,31916,2701581949,2604071683,1896622119,2389894496,3263588,176836282,7369515,30111,1880899689,95939274,30375224,110445,1081744194,7342536,140437297,2327177464,6241123073,1767949945,4494901008,38415244,9142325352,2713007487,29534,11043650,7724367,6712960,22353190,158204718,769074272,8801183,4062495,907644760,1978518931,18543452," +
            "\n老挝;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01OYQzHv1es9dHLTO3E_!!4118363926.png;1844255933" +
            "\n印度;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01NthNKJ1es9dHOgmEu_!!4118363926.png;818760062,18543452,119063," +
            "\n印度尼西亚;https://img.alicdn.com/imgextra/i3/4118363926/O1CN01Ji5nLh1es9dPtA1UN_!!4118363926.png;139041082,243494370,86407942,241808470,546570549,902578594,1119718690,597176126,1212886211,75953289,110445,737268056,6193918,74392051,1614864404,1366478571,2716462030,10614318,268456019,671738600,1669201481,234866148,3613185860,5820455747,46185831,94584,125844877,2879937184,1877172365,818760062,3196302231,178058712,49367114,778088651,3369167,109268733,54295625,1422848520,44652,101933356,20526831,967956571,771298006,21716993,268474504,3364978,2428373015,1877121082,74466387,55664";

    private static Map<String, String> BRAND_ID_TO_NATIONAL_FLAG = Maps.newHashMap();

    static {
        List<String> nationalList = Splitter.on("\n").trimResults().omitEmptyStrings().splitToList(NATIONAL_CODE);

        for (String nation : nationalList) {
            String[] split = nation.split(";");
            String flag = split[1];
            String s = split[2];
            List<String> brandList = Splitter.on(",").omitEmptyStrings().trimResults().splitToList(s);
            List<String> brandIdList = brandList.stream().filter(StringUtil::isNumeric).collect(Collectors.toList());
            brandIdList.forEach(brandId -> BRAND_ID_TO_NATIONAL_FLAG.put(brandId, flag));
        }
    }
    @Override
    public Response<ItemEntityVO> process(BuildItemVoRequest buildItemVoRequest) {

        ItemEntityVO itemEntityVO = new ItemEntityVO();
        itemEntityVO.put("contentType", 0);
        boolean hasMainSource = false;

        if (buildItemVoRequest == null || buildItemVoRequest.getItemInfoDTO() == null) {
            return Response.fail(ErrorCode.PARAMS_ERROR);
        }

        ItemInfoDTO itemInfoDTO = buildItemVoRequest.getItemInfoDTO();

        String originScm = "";
        String itemUrl = "";

        Map<String, String> trackPoint = Maps.newHashMap();

        for (String s : itemInfoDTO.getItemInfos().keySet()) {
            ItemInfoBySourceDTO itemInfoBySourceDTO = itemInfoDTO.getItemInfos().get(s);
            if (itemInfoBySourceDTO instanceof ItemInfoBySourceDTOMain) {
                ItemInfoBySourceDTOMain itemInfoBySourceDTOMain = (ItemInfoBySourceDTOMain) itemInfoBySourceDTO;
                itemUrl = Optional.of(itemInfoBySourceDTOMain)
                        .map(ItemInfoBySourceDTOMain::getItemDTO)
                        .map(ItemDataDTO::getDetailUrl)
                        .orElse("");
                itemEntityVO.put("treasureManPoint", getTreasureManPoint(itemInfoBySourceDTOMain));

                hasMainSource = true;
            }
            if (itemInfoBySourceDTO instanceof ItemInfoBySourceDTOOrigin) {
                ItemInfoBySourceDTOOrigin itemInfoBySourceDTOOrigin = (ItemInfoBySourceDTOOrigin) itemInfoBySourceDTO;
                originScm = itemInfoBySourceDTOOrigin.getScm();

            }
            Map<String, String> scmKeyValue = itemInfoBySourceDTO.getScmKeyValue();
            if (MapUtils.isNotEmpty(scmKeyValue)) {
                trackPoint.putAll(scmKeyValue);
            }
            itemEntityVO.putAll(itemInfoBySourceDTO.getItemInfoVO());

        }





        String scm = processScm(originScm, trackPoint);
        itemUrl = itemUrl + "&scm=" + scm;

        itemEntityVO.put("scm", scm);
        itemEntityVO.put("itemUrl", itemUrl);
        itemEntityVO.put("nationalFlag", getBrandNationalFlag(itemInfoDTO));


        if (!hasMainSource) {
            return Response.fail(ErrorCode.ITEM_VO_BUILD_ERROR_HAS_NO_MAIN_SOURCE);
        }
        return Response.success(itemEntityVO);
    }

    private Object getTreasureManPoint(ItemInfoBySourceDTOMain itemInfoBySourceDTOMain) {
        try {
            Object treasureManPoint = Optional.ofNullable(itemInfoBySourceDTOMain)
                    .map(ItemInfoBySourceDTOMain::getItemDTO)
                    .map(ItemDataDTO::getAttachment)
                    .map(att -> att.get("treasureManPoint"))
                    .orElse(null);
            if (treasureManPoint == null) {
                return null;
            }

            JSONObject jsonObject = JSON.parseObject(JSON.toJSONString(treasureManPoint));

            return Splitter.on(";").trimResults().omitEmptyStrings().splitToList(jsonObject.getString("content"));
        } catch (Exception e) {
            LOGGER.error("getTreasureManPoint error,", e);
        }
        return Lists.newArrayList();
    }


    private Object getBrandNationalFlag(ItemInfoDTO itemInfoDTO) {
        String brandId = Optional
                .ofNullable(itemInfoDTO)
                .map(ItemInfoDTO::getItemEntity)
                .map(ItemEntity::getBrandId)
                .orElse("");
        if (StringUtils.isEmpty(brandId)) {
            return "";
        }

        return BRAND_ID_TO_NATIONAL_FLAG.get(brandId);
    }

    private String processScm(String originScm, Map<String, String> scmKeyValue) {

        if (MapUtils.isEmpty(scmKeyValue)) {
            return originScm;
        }
        String addScm = Joiner.on("_").withKeyValueSeparator("-").join(scmKeyValue);

        return scmConvert(originScm, addScm);


    }

    public String scmConvert(String scm, String add) {
        try {

            if (StringUtils.isBlank(scm)) {
                return scm;
            }

            int index = scm.lastIndexOf("-");
            String prefixScm = scm.substring(0, index);
            String suffixScm = scm.substring(index);


            return prefixScm + "_" + add + suffixScm;
        } catch (Exception e) {
            //如果异常了就返回原来的
            LOGGER.error("scmConvertError", e);
            return scm;
        }
    }
}
